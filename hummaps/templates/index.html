{% extends 'base.html' %}

{%- block title %}Humboldt Map Index{% endblock title %}
{%- block styles %}
{{- super() }}
<style>
.map-item {
  position: relative;
  z-index: 0;
}
.pdf-button {
  display: block;
  position: absolute;
  top: 10px;
  right: 12px;
  z-index: 10;
}
</style>
{%- endblock styles -%}

{%- block navigation %}
<!-- begin navigation controls block -->
        <ul class="nav navbar-nav navbar-right">
          <li>
            <form class="navbar-form" role="search" action="{{ request.path }}" method="get">
              <div class="form-group">
                <div class="input-group">
                  <span class="input-group-btn">
                    <button class="btn btn-secondary" type="submit">
                      <span class="glyphicon glyphicon-search"></span>
                    </button>
                  </span>
                  <input id="search-query" class="form-control" type="text" name="q" value="{{ query }}" placeholder="Search for..." autofocus autocomplete="off" spellcheck="false">
                </div>
              </div>
            </form>
          </li>
          <li><a id="launch-dialog" data-toggle="modal" href="#search-dialog">popup</a></li>
          <li><a id="show-maps" href="#">maps</a></li>
          <li><a id="next" href="#">next</a></li>
          <li><a id="prev" href="#">prev</a></li>
          <li><a href="https://github.com/chasmack/hummaps/blob/master/README.md" target="_blank">about</a></li>
          <li><a href="https://github.com/chasmack/hummaps/blob/master/LOGS.md" target="_blank">logs</a></li>
        </ul>
<!-- end navigation controls -->
{%- endblock navigation -%}

{% block page %}
<!-- begin page content block -->
    <div id="map-list" class="container-fluid" hidden>
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          {% if not results -%}
          <h3 class="text-center">No maps</h3>
          {%- else -%}
          {%- if total > results|length -%}
          <h3 class="text-center">Showing 1-{{ results|count }} of {{ total }}</h3>
          {%- elif total > 1 -%}
          <h3 class="text-center">{{ results|count }} maps</h3>
          {%- else -%}
          <h3 class="text-center">1 map</h3>
          {%- endif %}
          <div class="list-group">
            {%- for map in results %}
            <div class="map-item">
              <!-- map item -->
              <a href="#" class="list-group-item map-info{%- if map.mapimages|length == 0 %} disabled{%- endif -%}" data-toggle="tooltip" title="map id: {{ map.id }}">
                <h4 class="list-group-item-heading">{{ map.heading }}</h4>
                <p class="list-group-item-text">{{ map.line1 }}</p>
                <p class="list-group-item-text">{{ map.line2 }}</p>
                {% if map.line3 -%}
                <p class="list-group-item-text">{{ map.line3 }}</p>
                {%- endif %}
                {% if map.line4 -%}
                <p class="list-group-item-text">{{ map.line4 }}</p>
                {%- endif %}
                {%- if map.certs|length > 0 -%}
                {%-  set comma = joiner(", ") %}
                <p class="list-group-item-text">Certificates of Correction: {% for cc in map.certs %}{{ comma() }}{{ cc.doc_number }}{% endfor %}</p>
                {% endif -%}
                {% if map.mapimages|length > 0 or map.certs|length > 0 %}
                <!-- list of map images -->
                <div class="map-image-list" style="display: none;">
                  {% for mapimage in map.mapimages -%}
                  <div class="map-image" data-src="{{ mapimage.imagefile }}" data-alt="{{ map.bookpage }} {{ mapimage.page }}/{{ map.mapimages|length }}"></div>
                  {% endfor -%}
                  {%- for cc in map.certs -%}
                  {% for ccimage in cc.ccimages -%}
                  <div class="map-image" data-src="{{ ccimage.imagefile }}" data-alt="{{ cc.doc_number }}"></div>
                {%- endfor %}
                {% endfor %}
                </div>
                {%- endif %}
                {%  if map.scans|length > 0 -%}
                <div class="scanfile-list" style="display: none;">
                {%- for scan in map.scans %}
                  <div class="scanfile" data-href="{{ scan.scanfile }}" data-alt="{{ scan.scanfile|basename|upper }}"></div>
                {%- endfor %}
                </div>
                {%- endif %}
              </a>
              {% if map.pdf %}
              <!-- link to the pdf -->
              <a href="{{ map.pdf.pdffile }}" download="{{ map.pdf.pdffile|basename }}.pdf"><button class="btn btn-default btn-xs pdf-button" style="padding: 2px 8px;"><strong>PDF</strong></button></a>
              {% endif %}
            </div>
            {%- endfor %}
          </div>
          {%- endif %}
        </div>
      </div>
    </div>
    <div id="map-frame" style="display: none">
      <div id="loader-frame" style="display: none;">
        <div id="loader"></div>
        <span style="margin-left: 12px;">Loading map image...</span>
      </div>
      <div id="map-name">
        <span></span>
      </div>
<!-- end page content block -->
{%- endblock page -%}

{% block dialog -%}
<!-- begin modal dialog -->
    <div id="search-dialog" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="queryModalLabel">Map Search</h4>
          </div>

          <div class="modal-body">
            <form class="form-horizontal">

              <div class="form-group">
                <label for="input-section" class="col-md-3 control-label">Section</label>
                <div class="col-md-7">
                  <input id="input-section" type="text" class="form-control" placeholder="eg. S12">
                </div>
                <div class="col-md-1 control-label">
                  <a href="#" tabindex="-1"><span class="glyphicon glyphicon-info-sign"></span></a>
                </div>
              </div>

              <div class="form-group">
                <label for="input-township" class="col-md-3 control-label">Township</label>
                <div class="col-md-7">
                  <input id="input-township" type="text" class="form-control" placeholder="eg. 7N">
                </div>
                <div class="col-md-1 control-label">
                  <a href="#" tabindex="-1"><span class="glyphicon glyphicon-info-sign"></span></a>
                </div>
              </div>

              <div class="form-group">
                <label for="input-range" class="col-md-3 control-label">Range</label>
                <div class="col-md-7">
                  <input id="input-range" type="text" class="form-control" placeholder="eg. 3E">
                </div>
                <div class="col-md-1 control-label">
                  <a href="#" tabindex="-1"><span class="glyphicon glyphicon-info-sign"></span></a>
                </div>
              </div>

              <div class="form-group">
                <label for="input-recdate" class="col-md-3 control-label">Date</label>
                <div class="col-md-3">
                  <input id="input-recdate" type="text" class="typeahead form-control" placeholder="eg. 12/2017" autocomplete="off" spellcheck="false">
                </div>
                <label for="input-recdate-to" class="col-md-1 control-label">To</label>
                <div class="col-md-3">
                  <input id="input-recdate-to" type="text" class="typeahead form-control" placeholder="" autocomplete="off" spellcheck="false">
                </div>
                <div class="col-md-1 control-label">
                  <a href="#" tabindex="-1"><span class="glyphicon glyphicon-info-sign"></span></a>
                </div>
              </div>

              <div class="form-group">
                <label for="input-surveyor" class="col-md-3 control-label">Surveyor</label>
                <div class="col-md-7">
                  <input id="input-surveyor" type="text" class="typeahead form-control" placeholder="type a name or number..." autocomplete="off" spellcheck="false">
                </div>
                <div class="col-md-1 control-label">
                  <a href="#" tabindex="-1"><span class="glyphicon glyphicon-info-sign"></span></a>
                </div>
              </div>

              <div class="form-group">
                <label for="input-client" class="col-md-3 control-label">Client</label>
                <div class="col-md-7">
                  <input id="input-client" type="text" class="form-control" placeholder="type a client or subdivision...">
                </div>
                <div class="col-md-1 control-label">
                  <a href="#" tabindex="-1"><span class="glyphicon glyphicon-info-sign"></span></a>
                </div>
              </div>

              <div class="form-group">
                <label for="input-description" class="col-md-3 control-label">Description</label>
                <div class="col-md-7">
                  <input id="input-description" type="text" class="form-control" placeholder="type a word or phrase...">
                </div>
                <div class="col-md-1 control-label">
                  <a href="#" tabindex="-1"><span class="glyphicon glyphicon-info-sign"></span></a>
                </div>
              </div>

              <div class="form-group">
                <label class="col-md-3 control-label">Map Type</label>
                <div class="checkbox col-md-4">
                  <label><input type="checkbox" checked>Corner Records (CR)</label>
                </div>
                <div class="checkbox col-md-4">
                  <label><input type="checkbox" checked>Parcel Maps (PM)</label>
                </div>
              </div>
              <div class="form-group">
                <div class="checkbox col-md-4 col-md-offset-3">
                  <label><input type="checkbox" checked>Subdivision Maps (RM)</label>
                </div>
                <div class="checkbox col-md-4">
                  <label><input type="checkbox" checked>Surveys (RS)</label>
                </div>
              </div>
              <div class="form-group">
                <div class="checkbox col-md-4 col-md-offset-3">
                  <label><input type="checkbox" checked>Unrecorded Maps (UR)</label>
                </div>
                <div class="checkbox col-md-4">
                  <label><input type="checkbox" checked>Others (HM, MM)</label>
                </div>
              </div>

              <div class="form-group">
                <label for="input-maps" class="col-md-3 control-label">Single Maps</label>
                <div class="col-md-7">
                  <input id="input-maps" type="text" class="form-control" placeholder="eg. 26RS50">
                </div>
                <div class="col-md-1 control-label">
                  <a href="#" tabindex="-1"><span class="glyphicon glyphicon-info-sign"></span></a>
                </div>
              </div>

            </form>
          </div>

          <div class="modal-footer" style="border-top-style: none;">
            <button id="search-submit" type="button" class="btn btn-primary btn-sm">Submit</button>
          </div>
        </div>
      </div>
    </div>

<!-- content for the help popovers -->
<div id="input-section-help" style="display: none;">
  <p>Type one or more section numbers separated by space -</p>
  <p style="padding-left: .5em"><strong>S12</strong></p>
  <p style="padding-left: .5em"><strong>S11 S12 S13 S14</strong></p>
  <p>Subsections can be added in front of the section numbers -</p>
  <p style="padding-left: .5em"><strong>S/2 S12</strong></p>
  <p style="padding-left: .5em"><strong>NE/4 SW/4 S16</strong></p>
</div>

<div id="input-township-help" style="display: none;">
  <p>Type a single township number followed by "N" or "S" - <strong>T6N</strong></p>
  <p>The "T" prefix is optional - <strong>6N</strong></p>
</div>

<div id="input-range-help" style="display: none;">
  <p>Type a single range number followed by "E" or "W" - <strong>R4E</strong></p>
  <p>The "R" prefix is optional - <strong>4E</strong></p>
</div>

<div id="input-recdate-help" style="display: none;">
  <p>Type a year, month or day like -</p>
  <p style="padding-left: .5em"><strong>2017</strong> or <strong>6/2017</strong> or <strong>6/22/2017</strong></p>
  <p>Use an optional second date in the "To" field to specify a date range.</p>
</div>

<div id="input-surveyor-help" style="display: none;">
  <p>Type a few characters of a name or LS/RCE number and select a surveyor from the list.</p>
</div>

<div id="input-client-help" style="display: none;">
  <p>Type a client or subdivision name. This field supports a limited set of
  <a href="https://www.postgresql.org/docs/9.4/static/functions-matching.html#FUNCTIONS-POSIX-REGEXP" target="_blank">regular expressions.</a></p>
</div>

<div id="input-description-help" style="display: none;">
  <p>Type a word or phrase from the map description. This field supports a limited set of
  <a href="https://www.postgresql.org/docs/9.4/static/functions-matching.html#FUNCTIONS-POSIX-REGEXP" target="_blank">regular expressions.</a></p>
</div>

<div id="input-maps-help" style="display: none;">
  <p>Type one or more maps specifying book and page, parcel map number or tract number -</p>
  <p style="padding-left: .5em"><strong>16RS123</strong></p>
  <p style="padding-left: .5em"><strong>PM123</strong></p>
  <p style="padding-left: .5em"><strong>TR123</strong></p>
  <p>Separate multiple maps with space -</p>
  <p style="padding-left: .5em"><strong>16RS123 PM123 TR123</strong></p>
</div>

<!-- end modal dialog -->
{%- endblock dialog -%}

{% block scripts %}
<!-- begin scripts block -->
    {{- super() }}
    <script src="{{ url_for('static', filename='js/jquery.mousewheel.js') }}"></script>
    <script src="{{ url_for('static', filename='js/hummaps.js', v='17.12.07') }}"></script>
    <script>

    $(function () {

      // Disable arrow key navigation when modal is open
      $('#search-dialog')
        .on('shown.bs.modal', function(e) {
          dialogOpen = true;
          $('#input-section').focus();
        }).on('hide.bs.modal', function(e) {
          dialogOpen = false;
        });

      // Initialize the BS popover plugin
      $('[data-toggle="popover"]').popover();

      // Initialize the popovers
      $('#input-section').parent().next().find('a').popover({
         trigger: 'focus',
         container: 'body',
         html: true,
         content: $('#input-section-help').html()
      });

      $('#input-township').parent().next().find('a').popover({
         trigger: 'focus',
         container: 'body',
         html: true,
         content: $('#input-township-help').html()
      });

      $('#input-range').parent().next().find('a').popover({
         trigger: 'focus',
         container: 'body',
         html: true,
         content: $('#input-range-help').html()
      });

      $('#input-recdate').parent().nextAll().last().find('a').popover({
         trigger: 'focus',
         container: 'body',
         html: true,
         content: $('#input-recdate-help').html()
      });

      $('#input-surveyor').parent().next().find('a').popover({
         trigger: 'focus',
         container: 'body',
         html: true,
         content: $('#input-surveyor-help').html()
      });

      $('#input-client').parent().nextAll().last().find('a').popover({
         trigger: 'focus',
         container: 'body',
         html: true,
         content: $('#input-client-help').html()
      });

      $('#input-description').parent().nextAll().last().find('a').popover({
         trigger: 'focus',
         container: 'body',
         html: true,
         content: $('#input-description-help').html()
      });

      $('#input-maps').parent().nextAll().last().find('a').popover({
         trigger: 'focus',
         container: 'body',
         html: true,
         content: $('#input-maps-help').html()
      });

      // lazy initialization of the surveyor typeahead
      $('#input-surveyor').one('input', function(e) {
        $.get('/', { req: 'surveyors'}, function(data) {
          console.log('init surveyors: ' + data.length + ' items');
          $('#input-surveyor').typeahead({
            source: data,
            appendTo: '#search-dialog',
            minLength: 2
          });
        }, 'json');
      });

      $('#search-submit').on('click', function (e) {

        var sec = $('#input-section').val();
        var tshp = $('#input-township').val();
        var rng = $('#input-range').val();
        var recdate = $('#input-recdate').val();
        var recdate_to = $('#input-recdate-to').val();
        var surveyor = $('#input-surveyor').val().replace(/ \(.*/, '');
        var client = $('#input-client').val();
        var desc = $('#input-description').val();
        var maps = $('#input-maps').val();

        $('#search-dialog').modal('hide');

        var q = '';
        if (tshp.length > 0 && rng.length > 0) {
          q += tshp + ' ' + rng;
          if (sec.length > 0) {
            q = sec + ' ' + q;
          }
        }

        if (recdate.length > 0) {
          if (recdate_to.length > 0) {
            q += ' date="' + recdate + ' ' + recdate_to + '"';
          } else {
            q += ' date=' + recdate;
          }
        }

        if (surveyor.length > 0) {
          q += ' by="' + surveyor + '"';
        }

        if (client.length > 0) {
          q += ' for="' + client + '"';
        }

        if (desc.length > 0) {
          q += ' desc="' + desc + '"';
        }

        if (maps.length > 0) {
          q += ' ' + maps;
        }

        if (q.length > 0) {
          $('#search-query').val(q);
          window.location.href = '/?q=' + q.trim();
        }

      });

    });

    </script>
<!-- end scripts block -->
{% endblock scripts %}
